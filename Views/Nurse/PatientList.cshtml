@model IEnumerable<Ward_Management_System.ViewModels.AdmissionViewModel>
@{
	ViewData["Title"] = "Admission List";
	Layout = "~/Views/Shared/_UserLayout.cshtml";

    // Ensure the ViewBag contains the necessary data for pagination
    Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}

@if (TempData["ToastMessage"] != null)
{
    var toastType = TempData["ToastType"] ?? "success";
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
            <div id="toastMessage" class="toast align-items-center text-bg-@toastType border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        @TempData["ToastMessage"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>
}

<div class="container-fluid patient-dashboard py-5">
    <div class="row justify-content-center mb-4 ">
        <div class="col-md-10 text-center">
            <h2 class="fw-bold text-primary">List Of Patients</h2>
            <p>View List Of Patients & record patient vitals</p>
        </div>
    </div>

    @* Live Searching  *@
    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <input type="text" id="searchInput" class="form-control shadow-sm" placeholder="Search by name, ward, or ID...">
        </div>
    </div>

    @* Table *@

    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                @if (!Model.Any())
                {
                    <div class="alert alert-info text-center">
                        No Patients Currently Admitted
                    </div>
                }
                else
                {
                    <div class="card-body">
                        <table class="table table-hover align-middle" id="AdmissionTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Patient Name</th>
                                    <th>ID Number</th>
                                    <th>Ward</th>
                                    <th>Vitals</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int count = 1;
                                }
                                @foreach (var admission in Model)
                                {
                                    <tr>
                                        <td>@count</td>
                                        <td>@admission.PatientName</td>
                                        <td>@admission.IdNumber</td>
                                        <td>@admission.WardName</td>
                                        <td>
                                        @if (admission.FolderId != null && admission.FolderId > 0)
                                        {
                                            <button type="button"
                                                    class="btn btn-warning mt-3 text-dark"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#vitalsModal"
                                                    data-folder-id="@admission.FolderId"
                                                    data-patient-name="@admission.PatientName">
                                                Vitals
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button"
                                                    class="btn btn-outline-secondary mt-3"
                                                    disabled
                                                    title="Vitals can only be recorded after admission">
                                                Vitals
                                            </button>
                                        }

                                        </td>
                                    </tr>
                                    count++;
                                }
                            </tbody>
                        </table>
                    <!-- Vitals Modal -->
                    <div class="modal fade" id="vitalsModal" tabindex="-1" aria-labelledby="vitalsModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <form asp-controller="Nurse" asp-action="AddVitals" method="post">
                                    @Html.AntiForgeryToken()
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="vitalsModalLabel">Record Vitals for <span id="modalPatientName"></span></h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <div class="modal-body">
                                        <input type="hidden" name="FolderId" id="folderIdInput" />

                                        <input type="hidden" name="VitalsDate" value="@DateTime.Now.ToString("s")" />


                                        <div class="mb-3">
                                                <label for="Notes" class="form-label">Notes <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Add some notes."></i></label>
                                            <textarea class="form-control" name="Notes" required maxlength="1000"
                                                      title="Notes are required and must be 1000 characters or less">
                                            </textarea>
                                        </div>

                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label">Blood Type</label>
                                                <select class="form-control" name="BloodType" required title="Must be A+, A-, B+, B-, AB+, AB-, O+, or O-">
                                                    <option value="">-- Select Blood Type --</option>
                                                    <option value="A+">A+</option>
                                                    <option value="A-">A-</option>
                                                    <option value="B+">B+</option>
                                                    <option value="B-">B-</option>
                                                    <option value="AB+">AB+</option>
                                                    <option value="AB-">AB-</option>
                                                    <option value="O+">O+</option>
                                                    <option value="O-">O-</option>
                                                </select>

                                            </div>
                                            <div class="col-md-4">
                                                    <label class="form-label">Blood Pressure <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="eg. 120/80."></i></label>
                                                <input class="form-control" name="BloodPressure" required 
                                                       pattern="^\d{1,3}/\d{1,3}$" title="Blood pressure must be in format XXX/XX (e.g., 120/80)" />
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Heart Rate</label>
                                                    <input class="form-control" type="number" name="HeartRate" required min="30" max="250" 
                                                       title="Heart rate must be between 30 and 250 bpm" />
                                            </div>
                                            <div class="col-md-4">
                                                    <label class="form-label">Temperature (°C) <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="eg. 34.5."></i></label>
                                                    <input class="form-control" type="number" step="0.1" lang="en-US" name="Temperature" required min="34" max="46" />


                                            </div>
                                            <div class="col-md-4">
                                                    <label class="form-label">Respiratory Rate <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="eg. 50"></i></label>
                                                <input class="form-control" type="number" name="RespiratoryRate" required min="8" max="60"
                                                       title="Respiratory rate must be between 8 and 60 breaths per minute" />
                                            </div>
                                            <div class="col-md-4">
                                                    <label class="form-label">Oxygen Saturation (%) <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="eg. 90."></i></label>
                                                <input class="form-control" type="number" name="OxygenSaturation" required min="70" max="100"
                                                       title="Oxygen saturation must be between 70% and 100%" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary">Save Vitals</button>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    @*  Paging shared partial view *@
                    <div class="=container">
                        @if (pager.TotalPages > 0)
                        {
                            <ul class="pagination justify-content-end">
                                @if (pager.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="Nurse" asp-action="PatientList" asp-route-pg="1">First</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="Nurse" asp-action="PatientList" asp-route-pg="@(pager.CurrentPage - 1)">Previous</a>
                                    </li>
                                }
                                @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                {
                                    <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                        <a class="page-link" asp-controller="Nurse" asp-action="PatientList" asp-route-pg="@pge">@pge</a>
                                    </li>
                                }
                                @if (pager.CurrentPage < pager.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="Nurse" asp-action="PatientList" asp-route-pg="@(pager.CurrentPage + 1)">Next</a>
                                    </li>
                                    <li>
                                        <a class="page-link" asp-controller="Nurse" asp-action="PatientList" asp-route-pg="@(pager.TotalPages)">Last</a>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                    </div>
                }
            </div>
    </div>
    <!-- Back Button -->
    <div class="text-center mt-4">
        <a asp-action="Index" asp-controller="Nurse" class="btn btn-secondary px-4">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
        </a>
    </div>
    </div>
</div>
@section Scripts{
    <partial name="_ValidationScriptsPartial"/>
    <script>
        //Live Searching
        document.getElementById("searchInput").addEventListener("keyup", function () {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll("#AdmissionTable tbody tr");

        rows.forEach(row => {
        const rowText = row.innerText.toLowerCase();
        row.style.display = rowText.includes(searchValue) ? "" : "none";
        });
        });

        // injecting folder id to modal
         document.addEventListener('DOMContentLoaded', function () {
            const vitalsModal = document.getElementById('vitalsModal');

            vitalsModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;

                if (!button) return;

                const folderId = button.getAttribute('data-folder-id');
                const patientName = button.getAttribute('data-patient-name');

                document.getElementById('folderIdInput').value = folderId;
                document.getElementById('modalPatientName').textContent = patientName;
            });
        });

         document.addEventListener("DOMContentLoaded", function () {
            var toastEl = document.getElementById("toastMessage");
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });
         // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
}
