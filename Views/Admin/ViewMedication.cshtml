@{
    ViewData["Title"] = "View Medication";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
	// Ensure the ViewBag contains the necessary data for pagination
    Pager pager = new Pager();

    int pageNo = 0;
    if(ViewBag.Pager != null)
    {
		pager = ViewBag.Pager;
		pageNo = pager.CurrentPage;
	}

}
@if (TempData["ToastMessage"] != null)
{
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
            <div id="toastMessage" class="toast align-items-center text-bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        @TempData["ToastMessage"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
   </div>
}
 
<div class="container-fluid patient-dashboard py-5">
    <!-- Header -->
    <div class="row mb-4 justify-content-center">
        <div class="col-md-8 text-center">
            <h2 class="fw-bold text-dark">Medication List</h2>
        </div>
    </div>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            @foreach (var modelState in ViewData.ModelState.Values)
            {
                foreach (var error in modelState.Errors)
                {
                    <div>@error.ErrorMessage</div>
                }
            }
        </div>
    }


    <!-- Back Button -->
    <div class="mt-4">
        <a asp-controller="Admin" asp-action="Admin" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle"></i> Back
        </a>
    </div>
    <br/>

    <!-- Medication Filtering Form -->
    <form method="get" asp-controller="Admin" asp-action="ViewMedication" class="d-flex align-items-center mb-4 flex-wrap gap-3 w-100">

        <!-- Brand Filter -->
        <select class="form-select" name="brand" style="width: 300px;">
            <option value="">All Brands</option>
            @foreach (var brand in ViewBag.Brands as List<string>)
            {
                if (ViewBag.CurrentBrand == brand)
                {
                    <option value="@brand" selected>@brand</option>
                }
                else
                {
                    <option value="@brand">@brand</option>
                }
            }
        </select>



        <!-- Category Filter -->
        <select class="form-select" name="categoryId" style="width: 300px;">
            <option value="">All Categories</option>
            @foreach (var cat in ViewBag.Categories as List<MedicationCategory>)
            {
                if (ViewBag.CurrentCategoryId == cat.ID)
                {
                    <option value="@cat.ID" selected>@cat.Name</option>
                }
                else
                {
                    <option value="@cat.ID">@cat.Name</option>
                }
            }
        </select>

        <!-- Storage Filter -->
        <select class="form-select" name="storage" style="width: 300px;">
            <option value="">All Storages</option>
            @foreach (var storage in ViewBag.Storages as List<string>)
            {
                if (ViewBag.CurrentStorage == storage)
                {
                    <option value="@storage" selected>@storage</option>
                }
                else
                {
                    <option value="@storage">@storage</option>
                }
            }
        </select>

        <!-- Search Input -->
        <div class="input-group" style="flex: 1; min-width: 300px;">
            <input type="text" name="search" value="@(ViewBag.CurrentSearch ?? "")" class="form-control" placeholder="Search medication..." />
            <button type="submit" class="btn btn-primary">Filter</button>
            <a class="btn btn-outline-secondary" asp-controller="Admin" asp-action="ViewMedication">Clear</a>
        </div>

    </form>


    <div class="row">
        <!-- Table -->
        <div class="col-lg-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">

                    <div class="mb-3 text-end">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicationModal">
                            <i class="bi bi-plus-circle"></i> Add Medication
                        </button>
                    </div>

                    <table class="table table-hover  align-middle"  id="medicationTable">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Brand</th>
                                <th>Quantity Available</th>
                                <th>Batch Number</th>
                                <th>Storage</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int count = 1;
                            }
                            @foreach (var StockMedications in Model)
                            {
                                var lowStock = StockMedications.QuantityAvailable < 10 ? "table-danger" : "";
                                <tr class="@lowStock">
                                    <td>@count</td>
                                    <td>@StockMedications.Name</td>
                                    <td>@StockMedications.Brand</td>
                                    <td>@StockMedications.QuantityAvailable</td>
                                    <td>@StockMedications.BatchNumber</td>
                                    <td>@StockMedications.Storage</td>
                                    <td>@StockMedications.MedicationCategory?.Name</td>
                                    <td>
                                        <!-- Edit Button -->
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editModal"
                                                data-id="@StockMedications.MedId"
                                                data-name="@StockMedications.Name"
                                                data-brand="@StockMedications.Brand"
                                                data-quantity="@StockMedications.QuantityAvailable"
                                                data-batch="@StockMedications.BatchNumber"
                                                data-storage="@StockMedications.Storage"
                                                data-schedule="@StockMedications.Schedule"
                                                data-category="@StockMedications.MedicationCategory?.ID">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <!-- Delete Button -->
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteModal"
                                                data-id="@StockMedications.MedId"
                                                data-name="@StockMedications.Name">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>

                                </tr>

                                count++;
                            }
                        </tbody>
                    </table>
                      @*  Paging shared partial view *@
                    <div class="=container">
                        @if (pager.TotalPages > 0)
                        {
                            <ul class="pagination justify-content-end">
                                @if (pager.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="Admin" asp-action="ViewMedication" asp-route-pg="1">First</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="Admin" asp-action="ViewMedication" asp-route-pg="@(pager.CurrentPage - 1)">Previous</a>
                                    </li>
                                }
                                @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                {
                                    <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                        <a class="page-link" asp-controller="Admin" asp-action="ViewMedication" asp-route-pg="@pge">@pge</a>
                                    </li>
                                }
                                @if (pager.CurrentPage < pager.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="Admin" asp-action="ViewMedication" asp-route-pg="@(pager.CurrentPage + 1)">Next</a>
                                    </li>
                                    <li>
                                        <a class="page-link" asp-controller="Admin" asp-action="ViewMedication" asp-route-pg="@(pager.TotalPages)">Last</a>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>

            <!-- Medication Summary Report -->
            <div class="mt-5">
                <div class="mb-3">
                    <a asp-controller="Reports" asp-action="ExportMedicationSummaryToPdf" class="btn btn-danger">
                        <i class="bi bi-file-earmark-pdf-fill"></i> Export to PDF
                    </a>
                </div>
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Medication Summary by Category</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">Category</th>
                                        <th scope="col" class="text-center">Total Medications</th>
                                        <th scope="col">Distribution</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        // Calculate total medications for percentages
                                        int totalMeds = ((IEnumerable<dynamic>)ViewBag.CategorySummary).Sum(x => (int)x.Count);
                                    }

                                    @foreach (var item in ViewBag.CategorySummary)
                                    {
                                        var percent = totalMeds > 0 ? ((int)item.Count * 100 / totalMeds) : 0;

                                        <tr>
                                            <td>@item.Category</td>
                                            <td class="text-center fw-bold">@item.Count</td>
                                            <td style="width: 40%;">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar
                                                @(percent >= 50 ? "bg-danger" : percent >= 25 ? "bg-warning" : "bg-success")"
                                                         role="progressbar"
                                                         style="width:@percent%;"
                                                         aria-valuenow="@percent"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        @percent%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
   
    <!-- Add Medication Modal -->
    <div class="modal fade" id="addMedicationModal" tabindex="-1" aria-labelledby="addMedicationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="AddMedication" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addMedicationModalLabel">Add New Medication</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                       
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input name="Name" class="form-control" required pattern="[A-Za-z\s]+" title="Only letters and spaces allowed" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Brand</label>
                            <input name="Brand" class="form-control" required pattern="[A-Za-z0-9\s]+" title="Only alphanumeric characters and spaces allowed" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity Available</label>
                            <input name="QuantityAvailable" type="number" class="form-control" required min="1" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Batch Number</label>
                            <input name="BatchNumber" class="form-control" required pattern="[A-Z0-9]+" title="Use only uppercase letters and numbers" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Storage</label>
                            <input name="Storage" class="form-control" required maxlength="100" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schedule</label>
                            <input name="Schedule" class="form-control" required  />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select name="ID" class="form-select" required>
                                <option value="" disabled selected>Select Category</option>
                                @foreach (var category in ViewBag.Categories)
                                {
                                    <option value="@category.ID">@category.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Save</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    @* EDIT MODAL *@
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="EditMedication" method="post">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="editModalLabel">Edit Medication</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="MedId" id="edit-id" />
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input name="Name" id="edit-name" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Brand</label>
                            <input name="Brand" id="edit-brand" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity Available</label>
                            <input name="QuantityAvailable" id="edit-quantity" type="number" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Batch Number</label>
                            <input name="BatchNumber" id="edit-batch" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Storage</label>
                            <input name="Storage" id="edit-storage" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schedule</label>
                            <input name="Schedule" id="edit-schedule" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select name="ID" id="edit-category" class="form-select" required>
                                @foreach (var category in ViewBag.Categories)
                                {
                                    <option value="@category.ID">@category.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-warning rounded-pill shadow-sm text-dark">Update</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Soft Delete Medication Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <form asp-action="SoftDeleteMedication" method="post">
                    @Html.AntiForgeryToken()

                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteModalLabel">Delete Medication</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="MedId" id="delete-id" />
                        <p class="lead text-danger">Are you sure you want to delete <strong id="delete-name"></strong>?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger">Confirm Delete</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
@section Scripts {
<script>
    const editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;

        document.getElementById('edit-id').value = button.getAttribute('data-id');
        document.getElementById('edit-name').value = button.getAttribute('data-name');
        document.getElementById('edit-brand').value = button.getAttribute('data-brand');
        document.getElementById('edit-quantity').value = button.getAttribute('data-quantity');
        document.getElementById('edit-batch').value = button.getAttribute('data-batch');
        document.getElementById('edit-storage').value = button.getAttribute('data-storage');
             document.getElementById('edit-schedule').value = button.getAttribute('data-schedule');
        document.getElementById('edit-category').value = button.getAttribute('data-category');
    });

    //delete
               const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');

                console.log("Delete requested for ID:", id);
                document.getElementById('delete-id').value = id;
                document.getElementById('delete-name').textContent = name;
            });
        }

</script>
}

