@model IEnumerable<Appointment>

@{
    ViewData["Title"] = "My Appointments";
}

<h2 class="mb-4">My Appointments</h2>

@functions {
    public int CalculateAgeFromId(string idNumber)
    {
        if (string.IsNullOrEmpty(idNumber) || idNumber.Length < 6)
            return 0;

        try
        {
            var yearPart = int.Parse(idNumber.Substring(0, 2));
            var monthPart = int.Parse(idNumber.Substring(2, 2));
            var dayPart = int.Parse(idNumber.Substring(4, 2));

            var currentYear = DateTime.Now.Year % 100;
            var century = (yearPart <= currentYear) ? 2000 : 1900;

            if (monthPart < 1 || monthPart > 12)
                return 0;

            if (dayPart < 1 || dayPart > DateTime.DaysInMonth(century + yearPart, monthPart))
                return 0;

            var birthDate = new DateTime(century + yearPart, monthPart, dayPart);

            var age = DateTime.Today.Year - birthDate.Year;
            if (birthDate.Date > DateTime.Today.AddYears(-age))
                age--;

            return age;
        }
        catch
        {
            return 0; // fallback for invalid ID
        }
    }
}

@if (!Model.Any())
{
    <div class="alert alert-info">You have no scheduled appointments.</div>
}
else
{
    <table class="table table-striped table-hover align-middle">
        <thead class="table-success">
            <tr>
                <th>Patient Name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>ID Number</th>
                <th>Date</th>
                <th>Time</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var appt in Model)
            {
                <tr>
                    <td>@appt.FullName</td>
                    <td>@CalculateAgeFromId(appt.IdNumber)</td>
                    <td>@appt.Gender</td>
                    <td>@appt.IdNumber</td>
                    <td>@appt.PreferredDate.ToString("yyyy-MM-dd")</td>
                    <td>@appt.PreferredTime.ToString(@"hh\:mm")</td>
                    <td>@appt.Reason</td>
                    <td>
                        @if (appt.Status == "Completed")
                        {
                            <span class="badge bg-success">Completed</span>
                        }
                        else if (appt.Status == "Pending")
                        {
                            <span class="badge bg-warning text-dark">Pending</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@appt.Status</span>
                        }
                    </td>
                    <td>
                        <form asp-controller="Doctor"
                              asp-action="ScheduleFollowUp"
                              method="get"
                              class="d-inline">
                            <input type="hidden" name="appointmentId" value="@appt.AppointmentId" />
                            <button type="submit" class="btn btn-outline-success btn-sm">
                                Follow-Up
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>

}