@model IEnumerable<Ward_Management_System.ViewModels.AdmissionViewModel>
@{
    ViewData["Title"] = "Admission List";
    Layout = "~/Views/Shared/_UserLayout.cshtml";

    // Ensure the ViewBag contains the necessary data for pagination
    Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}
@if (TempData["ToastMessage"] != null)
{
    var toastType = TempData["ToastType"] ?? "success";
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
            <div id="toastMessage" class="toast align-items-center text-bg-@toastType border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        @TempData["ToastMessage"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>
}

<div class="container-fluid patient-dashboard py-5">
    <div class="row justify-content-center mb-4 ">
        <div class="col-md-10 text-center">
            <h2 class="fw-bold text-primary">List Of Patients</h2>
            <p>View List Of Patients & their vitals</p>
        </div>
    </div>

    @* Live Searching  *@
    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <input type="text" id="searchInput" class="form-control shadow-sm" placeholder="Search by name, ward, or ID...">
        </div>
    </div>

    @* Table *@
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                @if (!Model.Any())
                {
                    <div class="alert alert-info text-center">
                        No Patients Currently Admitted
                    </div>
                }
                else
                {
                    <div class="card-body">
                        <table class="table table-hover align-middle" id="AdmissionTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Patient Name</th>
                                    <th>ID Number</th>
                                    <th>Condition</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int count = 1;
                                }
                                @foreach (var admission in Model)
                                {
                                    <tr>
                                        <td>@count</td>
                                        <td>@admission.PatientName</td>
                                        <td>@admission.IdNumber</td>
                                        <td>@admission.Condition</td>
                                        <td>@admission.WardName</td>
                                        <td>
                                            @if (admission.FolderId != null && admission.FolderId > 0)
                                            {
                                                <a class="btn btn-outline-primary btn-sm view-vitals-btn"
                                                        data-folder-id="@admission.FolderId"
                                                        data-patient-name="@admission.PatientName">
                                                    View Vitals
                                                </a>
                                            }
                                            else
                                            {
                                                <a class="btn btn-secondary btn-sm" disabled title="Patient must be must have a folder to record vitals first">View Vitals</a>
                                            }
                                            @if (admission.Status == "Admitted")
                                            {
                                                <a asp-controller="Movement"
                                                   asp-action="Movement"
                                                   asp-route-admissionId="@admission.AdmissionId"
                                                   class="btn btn-outline-success btn-sm">
                                                    Movement
                                                </a>
                                            }
                                            else
                                            {
                                                <a class="btn btn-outline-success btn-sm" disabled title="Patient must be admitted first">Movement</a>

                                            }
                                            @if (admission.Status == "Admitted")
                                            {
                                                <a asp-controller="Doctor"
                                                   asp-action="DischargeForm"
                                                   asp-route-id="@admission.AppointmentId"
                                                   class="btn btn-warning btn-sm text-white">
                                                    Instruct Discharge
                                                </a>
                                            }
                                            else
                                            {
                                                <a class="btn btn-outline-warning btn-sm" disabled title="Patient must be admitted first">Instruct Discharge</a>

                                            }
                                            

                                        </td>
                                    </tr>
                                    count++;
                                }
                            </tbody>
                        </table>
						@* Modal for viewing vitals *@
                        <div class="modal fade" id="vitalsModal" tabindex="-1" aria-labelledby="vitalsModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title" id="vitalsModalLabel">Patient Vitals</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" id="vitalsModalBody">
                                        <!-- Content will be loaded here via AJAX -->
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-primary" id="viewFullHistoryBtn">View Vitals History</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @*  Paging shared partial view *@
                        <div class="=container">
                            @if (pager.TotalPages > 0)
                            {
                                <ul class="pagination justify-content-end">
                                    @if (pager.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="1">First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="@(pager.CurrentPage - 1)">Previous</a>
                                        </li>
                                    }
                                    @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                    {
                                        <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="@pge">@pge</a>
                                        </li>
                                    }
                                    @if (pager.CurrentPage < pager.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="@(pager.CurrentPage + 1)">Next</a>
                                        </li>
                                        <li>
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="@(pager.TotalPages)">Last</a>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
        <!-- Back Button -->
        <div class="text-center mt-4">
            <a asp-action="Index" asp-controller="Doctor" class="btn btn-secondary px-4">
                <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var toastEl = document.getElementById("toastMessage");
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });
   
        //Live Searching
        document.getElementById("searchInput").addEventListener("keyup", function () {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll("#AdmissionTable tbody tr");

        rows.forEach(row => {
        const rowText = row.innerText.toLowerCase();
        row.style.display = rowText.includes(searchValue) ? "" : "none";
        });
        });

         // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });

		// Handle View Vitals button click
                $(document).ready(function() {
                    let selectedFolderId = null;
            // Handle view vitals button click
            $(document).on('click', '.view-vitals-btn', function() {
               selectedFolderId = $(this).data('folder-id');
                const patientName = $(this).data('patient-name');

                // Update modal title
                $('#vitalsModalLabel').text(`Latest Vitals for ${patientName}`);

                // Load latest vitals
               loadVitals(selectedFolderId, true);

                // Show modal
                $('#vitalsModal').modal('show');
            });

            // Handle full history button click
            $('#viewFullHistoryBtn').click(function() {
               if (selectedFolderId !== null) {
            loadVitals(selectedFolderId, false);
            }
            $(this).hide();
            });

            function loadVitals(folderId, latestOnly) {
                $.ajax({
                    url: '@Url.Action("ViewVitals", "Doctor")',
                    type: 'GET',
                    data: {
                        folderId: folderId,
                        latestOnly: latestOnly
                    },
                    beforeSend: function() {
                        $('#vitalsModalBody').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                    },
                    success: function(data) {
                        $('#vitalsModalBody').html(data);
                        if (!latestOnly) {
                            $('#viewFullHistoryBtn').hide();
                        } else {
                            $('#viewFullHistoryBtn').show();
                        }
                    },
                    error: function() {
                        $('#vitalsModalBody').html('<div class="alert alert-danger">Error loading vitals data.</div>');
                    }
                });
            }

            // Initialize search functionality for full history
            $(document).on('keyup', '#searchInput', function() {
                const input = $(this).val().toLowerCase();
                $('#vitalsModalBody tbody tr').each(function() {
                    const rowText = $(this).text().toLowerCase();
                    $(this).toggle(rowText.includes(input));
                });
            });
        });
    </script>
}